<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T√©l√©chargements APK</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#10b981" />
  <style>
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.6); }
    .grid-auto-fit { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-emerald-50 to-white text-slate-800">
  <header class="sticky top-0 z-10 border-b border-emerald-100 bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-8 h-8 text-emerald-600"><path fill="currentColor" d="M17.6 9.48l1.3-2.25c.08-.14.04-.32-.1-.4s-.32-.04-.4.1l-1.33 2.3a7.05 7.05 0 00-9.14 0L6.6 6.93c-.08-.14-.26-.18-.4-.1s-.18.26-.1.4l1.3 2.26A6.97 6.97 0 004 16.5V19c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h10v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-2.5c0-2.06-.8-4.01-2.4-5.52zM8 15a1 1 0 110-2 1 1 0 010 2zm8 0a1 1 0 110-2 1 1 0 010 2z"/></svg>
      <h1 class="text-xl md:text-2xl font-semibold">T√©l√©chargements APK</h1>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 pb-24 pt-8">
    <section class="glass rounded-2xl border border-emerald-100 p-4 md:p-6 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-end gap-3 md:gap-4">
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1" for="q">Rechercher</label>
          <input id="q" type="search" placeholder="Nom d‚Äôapp, version, notes‚Ä¶" class="w-full rounded-xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-emerald-300" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="sort">Trier par</label>
          <select id="sort" class="rounded-xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-emerald-300">
            <option value="newest">Plus r√©cent d‚Äôabord</option>
            <option value="oldest">Plus ancien d‚Äôabord</option>
            <option value="name">Nom d‚Äôapp (A‚ÜíZ)</option>
          </select>
        </div>
      </div>
    </section>

    <section id="cards" class="mt-6 grid-auto-fit"></section>

    <footer class="mt-12 text-center text-sm text-slate-500">
      <p>Les t√©l√©chargements sont fournis via manifest <code>APKs/builds.json</code>.</p>
    </footer>
  </main>

  <template id="card-tpl">
    <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm hover:shadow-md transition">
      <div class="flex items-start gap-4">
        <div class="shrink-0">
          <div class="h-12 w-12 rounded-2xl bg-emerald-100 grid place-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-7 h-7 text-emerald-700"><path fill="currentColor" d="M17.6 9.48l1.3-2.25c.08-.14.04-.32-.1-.4s-.32-.04-.4.1l-1.33 2.3a7.05 7.05 0 00-9.14 0L6.6 6.93c-.08-.14-.26-.18-.4-.1s-.18.26-.1.4l1.3 2.26A6.97 6.97 0 004 16.5V19c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h10v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-2.5c0-2.06-.8-4.01-2.4-5.52zM8 15a1 1 0 110-2 1 1 0 010 2zm8 0a1 1 0 110-2 1 1 0 010 2z"/></svg>
          </div>
        </div>
        <div class="min-w-0 flex-1">
          <div class="flex flex-wrap items-baseline gap-x-2 gap-y-1">
            <h3 class="text-lg font-semibold truncate app-label"></h3>
            <span class="text-xs rounded-full bg-slate-100 px-2 py-1 font-medium version-badge"></span>
          </div>
          <p class="mt-1 text-sm text-slate-600 notes"></p>
          <div class="mt-3 flex flex-wrap items-center gap-2 text-sm text-slate-500">
            <span class="inline-flex items-center gap-1">üì¶ <span class="filename"></span></span>
            <span class="inline-flex items-center gap-1 hidden size">‚Ä¢ <span class="size-bytes"></span></span>
            <span class="inline-flex items-center gap-1 hidden date">‚Ä¢ <span class="date-text"></span></span>
          </div>
          <div class="mt-4 flex gap-2">
            <a class="download-btn inline-flex items-center justify-center rounded-xl border border-emerald-600 px-4 py-2 text-emerald-700 hover:bg-emerald-50 font-medium" download>‚¨áÔ∏è T√©l√©charger</a>
            <button class="copy-btn inline-flex items-center justify-center rounded-xl border border-slate-300 px-4 py-2 hover:bg-slate-50">üîó Copier le lien</button>
          </div>
        </div>
      </div>
    </article>
  </template>

  <!-- IMPORTANT: pas de await en top-level -->
  <script>
    // ---------- Utilitaires ----------
    function humanSize(bytes) {
      if (!Number.isFinite(bytes) || bytes < 0) return null;
      const units = ['o','Ko','Mo','Go','To'];
      let i = 0; let n = bytes;
      while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
      return (n >= 100 ? n.toFixed(0) : n >= 10 ? n.toFixed(1) : n.toFixed(2)) + ' ' + units[i];
    }

    function parseFromFilename(fname) {
      const base = String(fname || '').replace(/\.apk$/i, '');
      const m = base.match(/(.+)_([0-9]+(?:\.[0-9A-Za-z-]+)*)$/);
      const label = m ? m[1].replace(/[_-]+/g, ' ') : base;
      const version = m ? m[2] : '';
      return { label, version };
    }

    // ---------- Chargement du manifest ----------
    function fetchBuilds() {
      const tried = [];
      const candidates = [ 'APKs/builds.json', './APKs/builds.json', './builds.json', '/APKs/builds.json' ];
      return new Promise(async (resolve) => {
        for (const url of candidates) {
          try {
            tried.push(url);
            const res = await fetch(url, { cache: 'no-store' });
            if (res.ok) {
              const arr = await res.json();
              if (Array.isArray(arr)) return resolve(arr);
            }
          } catch (e) {}
        }
        const c = document.getElementById('cards');
        if (c) {
          c.innerHTML = `<div class="rounded-xl border border-amber-200 bg-amber-50 p-4 text-amber-900">
            <strong>Manifest introuvable :</strong> impossible de charger <code>APKs/builds.json</code>.<br>
            Chemins test√©s : <code>${tried.join('</code>, <code>')}</code>
          </div>`;
        }
        resolve([]);
      });
    }

    // ---------- M√©tadonn√©es ----------
    async function enrichMeta(entry, baseUrl) {
      const fname = entry.file;
      const url = /^(https?:)?\/\//.test(fname) ? fname : `${baseUrl}${fname}`;

      if (!entry.label || !entry.version) {
        const p = parseFromFilename(fname);
        entry.label = entry.label || p.label;
        entry.version = entry.version || p.version;
      }

      try {
        const head = await fetch(url, { method: 'HEAD' });
        if (head.ok) {
          const size = head.headers.get('content-length');
          if (size) entry.size = Number(size);
          const lm = head.headers.get('last-modified');
          if (lm) entry.date = new Date(lm);
        }
      } catch (e) {}

      entry.url = url;
      return entry;
    }

    // ---------- Rendu ----------
    function renderCards(list) {
      const container = document.getElementById('cards');
      container.innerHTML = '';
      const tpl = document.getElementById('card-tpl');

      if (!list.length) {
        container.innerHTML = '<p class="text-slate-600">Aucun build trouv√©.</p>';
        return;
      }

      for (const b of list) {
        const node = tpl.content.cloneNode(true);
        node.querySelector('.app-label').textContent = b.label || 'APK';
        node.querySelector('.version-badge').textContent = b.version || '‚Äî';
        node.querySelector('.notes').textContent = b.notes || '';

        // n'affiche pas l'URL compl√®te : seulement un joli nom
        const prettyName = /^(https?:)?\/\//.test(b.file)
          ? (b.label ? `${b.label}.apk` : (b.file.split('?')[0].split('#')[0].split('/').pop() || 'fichier.apk'))
          : b.file;
        node.querySelector('.filename').textContent = prettyName;

        // bouton T√©l√©charger en <a>
        const a = node.querySelector('.download-btn');
        a.href = b.url;
        // extrait un nom de fichier potable pour l'attribut download (ignor√© parfois en cross-origin)
        const bn = (s) => {
          try { s = decodeURIComponent(String(s)); } catch(e) {}
          const m = s.split('?')[0].split('#')[0];
          const last = m.substring(m.lastIndexOf('/')+1);
          return last || 'download.apk';
        };
        a.setAttribute('download', bn(b.file || 'download.apk'));

        // bouton Copier le lien
        node.querySelector('.copy-btn').addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(new URL(b.url, window.location.href).href);
            alert('Lien copi√© dans le presse-papiers');
          } catch (e) {
            prompt('Copiez ce lien :', new URL(b.url, window.location.href).href);
          }
        });

        container.appendChild(node);
      }
    }

    function applyFiltersSort(data) {
      const q = document.getElementById('q').value.trim().toLowerCase();
      const sort = document.getElementById('sort').value;

      let arr = data.filter(b => {
        const hay = [b.label, b.version, b.file, b.notes].filter(Boolean).join(' ').toLowerCase();
        return hay.includes(q);
      });

      arr.sort((a, b) => {
        if (sort === 'name') return (a.label || '').localeCompare(b.label || '');
        const ta = (b.date instanceof Date && !isNaN(b.date)) ? b.date.getTime() : -Infinity;
        const tb = (a.date instanceof Date && !isNaN(a.date)) ? a.date.getTime() : -Infinity;
        // on veut newest par d√©faut => tb - ta car on a invers√© pour garder compat
        return sort === 'oldest' ? - (tb - ta) : (tb - ta);
      });

      return arr;
    }

    // ---------- D√©marrage (aucun await en top-level) ----------
    (function init() {
      const baseUrl = 'APKs/';
      fetchBuilds().then(async (builds) => {
        const enriched = await Promise.all(builds.map(e => enrichMeta({ ...e }, baseUrl)));
        const update = () => renderCards(applyFiltersSort(enriched));
        document.getElementById('q').addEventListener('input', update);
        document.getElementById('sort').addEventListener('change', update);
        update();
      });
    })();
  </script>
</body>
</html>
